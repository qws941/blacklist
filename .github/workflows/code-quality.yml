name: ğŸ” Code Quality & Security Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 2ì‹œ

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout ì½”ë“œ
      uses: actions/checkout@v4
      
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black isort bandit safety
        
    - name: ğŸ¨ ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ (Black)
      run: |
        echo "ğŸ¨ Black ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬..."
        black --check --diff src/ || echo "âš ï¸ ì½”ë“œ í¬ë§·íŒ… ê°œì„  í•„ìš”"
        
    - name: ğŸ“ Import ì •ë ¬ ê²€ì‚¬ (isort)
      run: |
        echo "ğŸ“ Import ì •ë ¬ ê²€ì‚¬..."
        isort --check-only --diff src/ || echo "âš ï¸ Import ì •ë ¬ ê°œì„  í•„ìš”"
        
    - name: ğŸ” ë¬¸ë²• ë° ìŠ¤íƒ€ì¼ ê²€ì‚¬ (Flake8)
      run: |
        echo "ğŸ” Flake8 ë¬¸ë²• ë° ìŠ¤íƒ€ì¼ ê²€ì‚¬..."
        flake8 src/ --max-line-length=88 --extend-ignore=E203,W503 || echo "âš ï¸ ì½”ë“œ ìŠ¤íƒ€ì¼ ê°œì„  í•„ìš”"
        
    - name: ğŸ”’ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ (Bandit)
      run: |
        echo "ğŸ”’ Bandit ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬..."
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/ || echo "âš ï¸ ë³´ì•ˆ ì´ìŠˆ ë°œê²¬ - ê²€í†  í•„ìš”"
        
    - name: ğŸ›¡ï¸ ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬ (Safety)
      run: |
        echo "ğŸ›¡ï¸ Safety ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬..."
        safety check || echo "âš ï¸ ì˜ì¡´ì„± ë³´ì•ˆ ì´ìŠˆ ë°œê²¬ - ì—…ë°ì´íŠ¸ í•„ìš”"
        
    - name: ğŸ“Š ì½”ë“œ í’ˆì§ˆ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: code-quality-reports
        path: |
          bandit-report.json
        retention-days: 30
        
  dockerfile-lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout ì½”ë“œ
      uses: actions/checkout@v4
      
    - name: ğŸ³ Dockerfile Lint
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        format: tty
        
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout ì½”ë“œ
      uses: actions/checkout@v4
      
    - name: ğŸ” Trivy ë³´ì•ˆ ìŠ¤ìº” (íŒŒì¼ì‹œìŠ¤í…œ)
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ“Š SARIF ê²°ê³¼ ì—…ë¡œë“œ
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
        
  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout ì½”ë“œ
      uses: actions/checkout@v4
      
    - name: ğŸ” Dependency Review
      uses: actions/dependency-review-action@v3
      with:
        fail-on-severity: moderate
        
  summary:
    needs: [code-quality, dockerfile-lint, security-scan]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“‹ í’ˆì§ˆ ê²€ì‚¬ ìš”ì•½
      run: |
        echo "## ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼ ìš”ì•½"
        echo ""
        echo "### ğŸ“Š ê²€ì‚¬ í•­ëª©ë³„ ê²°ê³¼:"
        echo "- ì½”ë“œ í’ˆì§ˆ: ${{ needs.code-quality.result }}"
        echo "- Dockerfile ë¦°íŠ¸: ${{ needs.dockerfile-lint.result }}"
        echo "- ë³´ì•ˆ ìŠ¤ìº”: ${{ needs.security-scan.result }}"
        echo ""
        
        if [[ "${{ needs.code-quality.result }}" == "success" && \
              "${{ needs.dockerfile-lint.result }}" == "success" && \
              "${{ needs.security-scan.result }}" == "success" ]]; then
          echo "âœ… ëª¨ë“  í’ˆì§ˆ ê²€ì‚¬ í†µê³¼!"
          echo "ğŸš€ ì½”ë“œê°€ ë°°í¬ ì¤€ë¹„ ìƒíƒœì…ë‹ˆë‹¤"
        else
          echo "âš ï¸ ì¼ë¶€ ê²€ì‚¬ì—ì„œ ì´ìŠˆ ë°œê²¬"
          echo "ğŸ”§ ê°œì„ ì´ í•„ìš”í•œ í•­ëª©ì„ í™•ì¸í•´ì£¼ì„¸ìš”"
        fi