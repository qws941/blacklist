name: ğŸš€ Main CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'services/*/Dockerfile'
      - 'docker-compose*.yml'
      - 'requirements.txt'
      - 'main.py'
      - 'gunicorn.conf.py'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build all images'
        required: false
        default: 'false'
        type: boolean
      target_images:
        description: 'Target images (comma-separated: app,postgres,redis)'
        required: false
        default: 'all'
      version_type:
        description: 'Version bump type'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

env:
  REGISTRY: registry.jclee.me
  REGISTRY_USER: admin
  PROJECT_NAME: blacklist

jobs:
  # í†µí•© ë³€ê²½ì‚¬í•­ ë¶„ì„ ë° SHA ê¸°ë°˜ ë²„ì „ ê´€ë¦¬
  analyze-and-version:
    name: ğŸ“Š Analysis & SHA Version Management
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.sha-version.outputs.version }}
      semantic-version: ${{ steps.sha-version.outputs.semantic-version }}
      short-sha: ${{ steps.sha-version.outputs.short-sha }}
      build-number: ${{ steps.sha-version.outputs.build-number }}
      should-build: ${{ steps.decision.outputs.should-build }}
      build-app: ${{ steps.changes.outputs.app }}
      build-postgres: ${{ steps.changes.outputs.postgres }}
      build-redis: ${{ steps.changes.outputs.redis }}
      
    steps:
    - name: ğŸ›ï¸ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Full history for accurate version calculation
        
    - name: ğŸ” ë³€ê²½ì‚¬í•­ ê°ì§€
      uses: dorny/paths-filter@v3
      id: changes
      with:
        filters: |
          app:
            - 'src/**'
            - 'main.py'
            - 'services/app/Dockerfile'
            - 'requirements.txt'
            - 'gunicorn.conf.py'
          postgres:
            - 'services/postgres/Dockerfile'
            - 'src/core/database/**'
            - 'instance/**'
          redis:
            - 'services/redis/Dockerfile'
            - 'config/redis/**'
          any:
            - 'src/**'
            - 'services/*/Dockerfile'
            - 'docker-compose*.yml'
            - 'requirements.txt'
            - '.github/workflows/**'
            
    - name: ğŸ·ï¸ SHA ê¸°ë°˜ ë™ì  ë²„ì „ ê³„ì‚°
      id: sha-version
      run: |
        # ê¸°ë³¸ Git ì •ë³´ ìˆ˜ì§‘
        SHORT_SHA=$(git rev-parse --short HEAD)
        FULL_SHA=$(git rev-parse HEAD)
        BRANCH=$(git rev-parse --abbrev-ref HEAD)
        BUILD_NUMBER=${{ github.run_number }}
        TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
        
        # í˜„ì¬ ì‹œë§¨í‹± ë²„ì „ ì½ê¸°
        if [[ -f "VERSION" ]]; then
          CURRENT_SEMANTIC=$(cat VERSION)
        else
          CURRENT_SEMANTIC="1.0.0"
        fi
        
        # ë²„ì „ ë²”í”„ ê²°ì • (ìˆ˜ë™ vs ìë™)
        if [[ "${{ github.event.inputs.version_type }}" != "auto" ]] && [[ "${{ github.event.inputs.version_type }}" != "" ]]; then
          # ìˆ˜ë™ ë²„ì „ ë²”í”„
          case "${{ github.event.inputs.version_type }}" in
            patch)
              SEMANTIC_VERSION=$(echo $CURRENT_SEMANTIC | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
              BUMP_TYPE="patch"
              ;;
            minor)
              SEMANTIC_VERSION=$(echo $CURRENT_SEMANTIC | awk -F. '{$(NF-1) = $(NF-1) + 1; $NF = 0;} 1' | sed 's/ /./g')
              BUMP_TYPE="minor"
              ;;
            major)
              SEMANTIC_VERSION=$(echo $CURRENT_SEMANTIC | awk -F. '{$1 = $1 + 1; $2 = 0; $3 = 0;} 1' | sed 's/ /./g')
              BUMP_TYPE="major"
              ;;
          esac
        else
          # ì»¤ë°‹ ë©”ì‹œì§€ ê¸°ë°˜ ìë™ ë²„ì „ ê³„ì‚°
          COMMIT_MSGS=$(git log --oneline -5 --format=%s)
          
          if echo "$COMMIT_MSGS" | grep -qE "(BREAKING|breaking|!:|feat!:|fix!:)"; then
            SEMANTIC_VERSION=$(echo $CURRENT_SEMANTIC | awk -F. '{$1 = $1 + 1; $2 = 0; $3 = 0;} 1' | sed 's/ /./g')
            BUMP_TYPE="major"
          elif echo "$COMMIT_MSGS" | grep -qE "(^feat:|^feat\(|feature:|add |implement )"; then
            SEMANTIC_VERSION=$(echo $CURRENT_SEMANTIC | awk -F. '{$(NF-1) = $(NF-1) + 1; $NF = 0;} 1' | sed 's/ /./g')
            BUMP_TYPE="minor"
          else
            SEMANTIC_VERSION=$(echo $CURRENT_SEMANTIC | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
            BUMP_TYPE="patch"
          fi
        fi
        
        # í¬ê´„ì  SHA ê¸°ë°˜ ë²„ì „ ìƒì„±
        # í˜•ì‹: {semantic}-build{build}-{sha}-{timestamp}
        SHA_VERSION="${SEMANTIC_VERSION}-build${BUILD_NUMBER}-${SHORT_SHA}-${TIMESTAMP}"
        
        # ì¶œë ¥ ë³€ìˆ˜ ì„¤ì •
        echo "version=${SHA_VERSION}" >> $GITHUB_OUTPUT
        echo "semantic-version=${SEMANTIC_VERSION}" >> $GITHUB_OUTPUT
        echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "build-number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
        echo "bump-type=${BUMP_TYPE}" >> $GITHUB_OUTPUT
        
        # ìƒì„¸í•œ ë²„ì „ ì •ë³´ JSON ìƒì„±
        cat > version-info.json <<EOF
        {
          "version": "${SHA_VERSION}",
          "semantic_version": "${SEMANTIC_VERSION}",
          "build_number": ${BUILD_NUMBER},
          "bump_type": "${BUMP_TYPE}",
          "sha": {
            "short": "${SHORT_SHA}",
            "full": "${FULL_SHA}"
          },
          "git": {
            "branch": "${BRANCH}",
            "commit_count": $(git rev-list --count HEAD),
            "timestamp": "$(git log -1 --format=%cI)",
            "last_commit_message": $(git log -1 --format=%s | jq -R .)
          },
          "build": {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "runner": "github-actions",
            "workflow": "${{ github.workflow }}",
            "run_id": "${{ github.run_id }}"
          }
        }
        EOF
        
        echo "ğŸ“‹ Version Information:"
        echo "  ğŸ·ï¸ SHA Version: ${SHA_VERSION}"
        echo "  ğŸ“¦ Semantic: ${SEMANTIC_VERSION} (${BUMP_TYPE} bump)"
        echo "  ğŸ—ï¸ Build: ${BUILD_NUMBER}"
        echo "  ğŸ“ SHA: ${SHORT_SHA}"
        
        # VERSION íŒŒì¼ ì—…ë°ì´íŠ¸ (ì»¤ë°‹ ì—†ì´)
        echo "${SEMANTIC_VERSION}" > VERSION
        
    - name: ğŸ¯ ë¹Œë“œ ê²°ì •
      id: decision
      run: |
        FORCE_BUILD="${{ github.event.inputs.force_build }}"
        TARGET_IMAGES="${{ github.event.inputs.target_images }}"
        
        # PRì¸ ê²½ìš° ë¹Œë“œí•˜ì§€ ì•ŠìŒ
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "should-build=false" >> $GITHUB_OUTPUT
          echo "ğŸ“ PR ì´ë²¤íŠ¸ - ë¹Œë“œ ìŠ¤í‚µ"
          exit 0
        fi
        
        # ê°•ì œ ë¹Œë“œì¸ ê²½ìš°
        if [[ "$FORCE_BUILD" == "true" ]]; then
          echo "should-build=true" >> $GITHUB_OUTPUT
          echo "ğŸ”¨ ê°•ì œ ë¹Œë“œ ì‹¤í–‰"
          exit 0
        fi
        
        # ìˆ˜ë™ ë²„ì „ ì§€ì •ì¸ ê²½ìš°
        if [[ "${{ github.event.inputs.version_type }}" != "auto" ]] && [[ "${{ github.event.inputs.version_type }}" != "" ]]; then
          echo "should-build=true" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ ìˆ˜ë™ ë²„ì „ ì§€ì • - ë¹Œë“œ ì‹¤í–‰"
          exit 0
        fi
        
        # ë³€ê²½ì‚¬í•­ ê¸°ë°˜ ë¹Œë“œ
        if [[ "${{ steps.changes.outputs.any }}" == "true" ]]; then
          echo "should-build=true" >> $GITHUB_OUTPUT
          echo "âœ… ë³€ê²½ì‚¬í•­ ê°ì§€ - ë¹Œë“œ ì‹¤í–‰"
        else
          echo "should-build=false" >> $GITHUB_OUTPUT
          echo "ğŸ“­ ë³€ê²½ì‚¬í•­ ì—†ìŒ - ë¹Œë“œ ìŠ¤í‚µ"
        fi
        
    - name: ğŸ“¤ ë²„ì „ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: version-info
        path: |
          version-info.json
          VERSION
        retention-days: 30

  # ìµœì í™”ëœ ë©€í‹° ì´ë¯¸ì§€ ë¹Œë“œ
  build-and-push:
    name: ğŸ³ Build & Push (${{ matrix.name }})
    runs-on: ubuntu-latest
    needs: analyze-and-version
    if: needs.analyze-and-version.outputs.should-build == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: app
            dockerfile: services/app/Dockerfile
            context: .
            build_condition: ${{ needs.analyze-and-version.outputs.build-app }}
          - name: postgres  
            dockerfile: services/postgres/Dockerfile
            context: .
            build_condition: ${{ needs.analyze-and-version.outputs.build-postgres }}
          - name: redis
            dockerfile: services/redis/Dockerfile
            context: .
            build_condition: ${{ needs.analyze-and-version.outputs.build-redis }}
            
    steps:
    - name: â­ï¸ ì´ë¯¸ì§€ ë¹Œë“œ ì¡°ê±´ í™•ì¸
      id: should-build-image
      run: |
        FORCE_BUILD="${{ github.event.inputs.force_build }}"
        TARGET_IMAGES="${{ github.event.inputs.target_images }}"
        IMAGE_NAME="${{ matrix.name }}"
        BUILD_CONDITION="${{ matrix.build_condition }}"
        VERSION_TYPE="${{ github.event.inputs.version_type }}"
        
        # ê°•ì œ ë¹Œë“œ ë˜ëŠ” ì „ì²´ íƒ€ê²Ÿì¸ ê²½ìš°
        if [[ "$FORCE_BUILD" == "true" ]] || [[ "$TARGET_IMAGES" == "all" ]] || [[ -z "$TARGET_IMAGES" ]]; then
          echo "should-build=true" >> $GITHUB_OUTPUT
          echo "ğŸ”¨ $IMAGE_NAME ì´ë¯¸ì§€ ë¹Œë“œ ì˜ˆì • (ê°•ì œ/ì „ì²´)"
          exit 0
        fi
        
        # ìˆ˜ë™ ë²„ì „ ì§€ì •ì¸ ê²½ìš°
        if [[ "$VERSION_TYPE" != "auto" ]] && [[ "$VERSION_TYPE" != "" ]]; then
          echo "should-build=true" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ $IMAGE_NAME ì´ë¯¸ì§€ ë¹Œë“œ ì˜ˆì • (ìˆ˜ë™ ë²„ì „)"
          exit 0
        fi
        
        # íŠ¹ì • íƒ€ê²Ÿ ì§€ì •ëœ ê²½ìš°
        if [[ "$TARGET_IMAGES" == *"$IMAGE_NAME"* ]]; then
          echo "should-build=true" >> $GITHUB_OUTPUT
          echo "ğŸ¯ $IMAGE_NAME ì´ë¯¸ì§€ ë¹Œë“œ ì˜ˆì • (íƒ€ê²Ÿ ì§€ì •)"
          exit 0
        fi
        
        # ë³€ê²½ì‚¬í•­ ê¸°ë°˜ ë¹Œë“œ
        if [[ "$BUILD_CONDITION" == "true" ]]; then
          echo "should-build=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ $IMAGE_NAME ì´ë¯¸ì§€ ë¹Œë“œ ì˜ˆì • (ë³€ê²½ì‚¬í•­)"
        else
          echo "should-build=false" >> $GITHUB_OUTPUT
          echo "â­ï¸ $IMAGE_NAME ì´ë¯¸ì§€ ë¹Œë“œ ìŠ¤í‚µ"
        fi
        
    - name: ğŸ“¥ Checkout Repository
      if: steps.should-build-image.outputs.should-build == 'true'
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ ë²„ì „ ì •ë³´ ë‹¤ìš´ë¡œë“œ
      if: steps.should-build-image.outputs.should-build == 'true'
      uses: actions/download-artifact@v4
      with:
        name: version-info
      
    - name: ğŸ—ï¸ Docker Buildx ì„¤ì •
      if: steps.should-build-image.outputs.should-build == 'true'
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” í”„ë¼ì´ë¹— ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
      if: steps.should-build-image.outputs.should-build == 'true'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ env.REGISTRY_USER }}
        password: ${{ secrets.REGISTRY_PASSWORD }}
        
    - name: ğŸ“‹ ë©”íƒ€ë°ì´í„° ë° íƒœê·¸ ìƒì„±
      if: steps.should-build-image.outputs.should-build == 'true'
      id: meta
      run: |
        SHA_VERSION="${{ needs.analyze-and-version.outputs.version }}"
        SEMANTIC="${{ needs.analyze-and-version.outputs.semantic-version }}"
        SHORT_SHA="${{ needs.analyze-and-version.outputs.short-sha }}"
        BUILD_NUM="${{ needs.analyze-and-version.outputs.build-number }}"
        IMAGE_NAME="${{ matrix.name }}"
        
        # í¬ê´„ì  íƒœê·¸ ëª©ë¡ ìƒì„±
        TAGS="${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}-${IMAGE_NAME}:latest"
        TAGS="$TAGS,${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}-${IMAGE_NAME}:${SEMANTIC}"
        TAGS="$TAGS,${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}-${IMAGE_NAME}:${SEMANTIC}-${SHORT_SHA}"
        TAGS="$TAGS,${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}-${IMAGE_NAME}:build-${BUILD_NUM}"
        TAGS="$TAGS,${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}-${IMAGE_NAME}:${SHA_VERSION}"
        
        # ë©”íƒ€ë°ì´í„° ë¼ë²¨
        LABELS="org.opencontainers.image.title=${{ env.PROJECT_NAME }}-${IMAGE_NAME}"
        LABELS="$LABELS,org.opencontainers.image.description=Blacklist Management System - ${IMAGE_NAME}"
        LABELS="$LABELS,org.opencontainers.image.version=${SEMANTIC}"
        LABELS="$LABELS,org.opencontainers.image.vendor=jclee"
        LABELS="$LABELS,org.opencontainers.image.revision=${{ github.sha }}"
        LABELS="$LABELS,org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}"
        
        echo "tags=${TAGS}" >> $GITHUB_OUTPUT
        echo "labels=${LABELS}" >> $GITHUB_OUTPUT
        echo "sha-version=${SHA_VERSION}" >> $GITHUB_OUTPUT
        
        echo "ğŸ·ï¸ Generated tags for ${IMAGE_NAME}:"
        echo "${TAGS}" | tr ',' '\n' | sed 's/^/  - /'
        
    - name: ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      if: steps.should-build-image.outputs.should-build == 'true'
      uses: docker/build-push-action@v5
      with:
        context: ${{ matrix.context }}
        file: ${{ matrix.dockerfile }}
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha,scope=${{ matrix.name }}
        cache-to: type=gha,mode=max,scope=${{ matrix.name }}
        build-args: |
          VERSION=${{ steps.meta.outputs.sha-version }}
          BUILD_NUMBER=${{ needs.analyze-and-version.outputs.build-number }}
          VCS_REF=${{ github.sha }}
          BUILDTIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
    - name: âœ… ë¹Œë“œ ê²°ê³¼ ì¶œë ¥
      if: steps.should-build-image.outputs.should-build == 'true'
      run: |
        echo "ğŸ‰ ${{ matrix.name }} ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ!"
        echo "ğŸ“¦ ì´ë¯¸ì§€: ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}-${{ matrix.name }}"
        echo "ğŸ·ï¸ SHA ë²„ì „: ${{ steps.meta.outputs.sha-version }}"
        echo "ğŸ“¦ ì‹œë§¨í‹± ë²„ì „: ${{ needs.analyze-and-version.outputs.semantic-version }}"
        echo "ğŸ“ Short SHA: ${{ needs.analyze-and-version.outputs.short-sha }}"
        echo "ğŸ—ï¸ ë¹Œë“œ ë²ˆí˜¸: ${{ needs.analyze-and-version.outputs.build-number }}"

  # ë³´ì•ˆ ìŠ¤ìº” (ì„ íƒì ) - ê¶Œí•œ ë¬¸ì œë¡œ SARIF ì—…ë¡œë“œ ì œê±°
  security-scan:
    name: ğŸ›¡ï¸ Security Scan (${{ matrix.image }})
    runs-on: ubuntu-latest
    needs: [analyze-and-version, build-and-push]
    if: needs.analyze-and-version.outputs.should-build == 'true' && github.ref == 'refs/heads/main'
    
    strategy:
      fail-fast: false
      matrix:
        image: [app, postgres, redis]
        
    steps:
    - name: ğŸ” ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ env.REGISTRY_USER }}
        password: ${{ secrets.REGISTRY_PASSWORD }}
        
    - name: ğŸ›¡ï¸ Trivy ë³´ì•ˆ ìŠ¤ìº”
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}-${{ matrix.image }}:${{ needs.analyze-and-version.outputs.semantic-version }}
        format: 'table'
        
    - name: ğŸ“Š ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ
      run: |
        echo "ğŸ›¡ï¸ ${{ matrix.image }} ì´ë¯¸ì§€ ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ"
        echo "âœ… Trivy ìŠ¤ìº”ì´ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤"

  # GitHub Release ìƒì„± - ê¶Œí•œ ë¬¸ì œë¡œ ì œê±°í•˜ê³  ìš”ì•½ìœ¼ë¡œ ëŒ€ì²´
  create-deployment-summary:
    name: ğŸ“‹ Deployment Summary
    runs-on: ubuntu-latest
    needs: [analyze-and-version, build-and-push]
    if: needs.analyze-and-version.outputs.should-build == 'true' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ ë²„ì „ ì •ë³´ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        name: version-info
        
    - name: ğŸ“‹ ë°°í¬ ìš”ì•½ ìƒì„±
      run: |
        SHA_VERSION="${{ needs.analyze-and-version.outputs.version }}"
        SEMANTIC="${{ needs.analyze-and-version.outputs.semantic-version }}"
        SHORT_SHA="${{ needs.analyze-and-version.outputs.short-sha }}"
        BUILD_NUM="${{ needs.analyze-and-version.outputs.build-number }}"
        
        echo "## ğŸš€ ë°°í¬ ì™„ë£Œ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**SHA Version:** \`${SHA_VERSION}\`" >> $GITHUB_STEP_SUMMARY
        echo "**ì‹œë§¨í‹± ë²„ì „:** \`${SEMANTIC}\`" >> $GITHUB_STEP_SUMMARY
        echo "**ë¹Œë“œ ë²ˆí˜¸:** #${BUILD_NUM}" >> $GITHUB_STEP_SUMMARY
        echo "**SHA:** \`${SHORT_SHA}\`" >> $GITHUB_STEP_SUMMARY
        echo "**ë°°í¬ ì‹œê°„:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ“¦ ë¹Œë“œëœ ì´ë¯¸ì§€ë“¤" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ëª…ë ¹ì–´" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}-app:${SEMANTIC}" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}-postgres:${SEMANTIC}" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}-redis:${SEMANTIC}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# ë˜ëŠ” latest íƒœê·¸ ì‚¬ìš©" >> $GITHUB_STEP_SUMMARY
        echo "docker-compose pull && docker-compose up -d" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ“‹ ë³€ê²½ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
        echo "- **ì•±**: ${{ needs.analyze-and-version.outputs.build-app == 'true' && 'âœ… ë³€ê²½ë¨' || 'âŒ ë³€ê²½ì—†ìŒ' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **PostgreSQL**: ${{ needs.analyze-and-version.outputs.build-postgres == 'true' && 'âœ… ë³€ê²½ë¨' || 'âŒ ë³€ê²½ì—†ìŒ' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Redis**: ${{ needs.analyze-and-version.outputs.build-redis == 'true' && 'âœ… ë³€ê²½ë¨' || 'âŒ ë³€ê²½ì—†ìŒ' }}" >> $GITHUB_STEP_SUMMARY
        
        echo "ğŸ‰ ëª¨ë“  ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ë¹Œë“œë˜ê³  ${{ env.REGISTRY }}ì— í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤!"

  # ìµœì¢… ìš”ì•½ ë° ì•Œë¦¼
  pipeline-summary:
    name: ğŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [analyze-and-version, build-and-push, security-scan, create-deployment-summary]
    if: always()
    
    steps:
    - name: ğŸ“‹ ì „ì²´ íŒŒì´í”„ë¼ì¸ ìš”ì•½
      run: |
        echo "## ğŸš€ ìµœì í™”ëœ CI/CD íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ“‹ ê¸°ë³¸ ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "- **ì´ë²¤íŠ¸**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¸Œëœì¹˜**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.analyze-and-version.outputs.should-build }}" == "true" ]]; then
          echo "- **SHA ë²„ì „**: ${{ needs.analyze-and-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹œë§¨í‹± ë²„ì „**: ${{ needs.analyze-and-version.outputs.semantic-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¹Œë“œ ë²ˆí˜¸**: ${{ needs.analyze-and-version.outputs.build-number }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ”„ ë³€ê²½ì‚¬í•­ ë¶„ì„" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ needs.analyze-and-version.outputs.should-build }}" == "true" ]]; then
          echo "- **ì•±**: ${{ needs.analyze-and-version.outputs.build-app == 'true' && 'âœ… ë³€ê²½ë¨' || 'âŒ ë³€ê²½ì—†ìŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PostgreSQL**: ${{ needs.analyze-and-version.outputs.build-postgres == 'true' && 'âœ… ë³€ê²½ë¨' || 'âŒ ë³€ê²½ì—†ìŒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Redis**: ${{ needs.analyze-and-version.outputs.build-redis == 'true' && 'âœ… ë³€ê²½ë¨' || 'âŒ ë³€ê²½ì—†ìŒ' }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **ë¹Œë“œ**: â­ï¸ ìŠ¤í‚µë¨ (ë³€ê²½ì‚¬í•­ ì—†ìŒ)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ“¦ ì‹¤í–‰ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¶„ì„ & ë²„ì „**: ${{ needs.analyze-and-version.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.analyze-and-version.outputs.should-build }}" == "true" ]]; then
          echo "- **ë¹Œë“œ & í‘¸ì‹œ**: ${{ needs.build-and-push.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë³´ì•ˆ ìŠ¤ìº”**: ${{ needs.security-scan.result == 'success' && 'âœ… ì™„ë£Œ' || needs.security-scan.result == 'skipped' && 'â­ï¸ ìŠ¤í‚µ' || 'âŒ ì‹¤íŒ¨' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë°°í¬ ìš”ì•½**: ${{ needs.create-deployment-summary.result == 'success' && 'âœ… ì™„ë£Œ' || needs.create-deployment-summary.result == 'skipped' && 'â­ï¸ ìŠ¤í‚µ' || 'âŒ ì‹¤íŒ¨' }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ needs.analyze-and-version.outputs.should-build }}" == "true" ]]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“± ì´ë¯¸ì§€ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}-app:${{ needs.analyze-and-version.outputs.semantic-version }}" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}-postgres:${{ needs.analyze-and-version.outputs.semantic-version }}" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}-redis:${{ needs.analyze-and-version.outputs.semantic-version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*ğŸ¤– ìµœì í™”ëœ ë‹¨ì¼ íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ í†µí•© ì™„ë£Œ - SHA ê¸°ë°˜ ë™ì  ë²„ì „ ê´€ë¦¬ + ìŠ¤ë§ˆíŠ¸ ë¹Œë“œ ì¡°ê±´*" >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸ‰ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ
      run: |
        if [[ "${{ needs.analyze-and-version.outputs.should-build }}" == "true" ]]; then
          echo "ğŸ‰ ìµœì í™”ëœ CI/CD íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì™„ë£Œ!"
          echo "ğŸ·ï¸ SHA ë²„ì „: ${{ needs.analyze-and-version.outputs.version }}"
          echo "ğŸ“¦ ì‹œë§¨í‹± ë²„ì „: ${{ needs.analyze-and-version.outputs.semantic-version }}"
          echo "ğŸš€ ëª¨ë“  ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ë¹Œë“œë˜ì–´ í”„ë¼ì´ë¹— ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤."
        else
          echo "ğŸ“­ ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ì„œ ë¹Œë“œë¥¼ ìŠ¤í‚µí–ˆìŠµë‹ˆë‹¤."
          echo "âš¡ ìµœì í™”ëœ íŒŒì´í”„ë¼ì¸ì´ ë¶ˆí•„ìš”í•œ ë¹Œë“œë¥¼ ë°©ì§€í–ˆìŠµë‹ˆë‹¤!"
        fi
        echo "ğŸ“… ì™„ë£Œ ì‹œê°„: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"